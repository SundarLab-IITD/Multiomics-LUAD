##Import omics dataset from which features at to be extracted
##This has to be done seperately for every omics type

rna = readtable('mRna_sorted_out.csv','ReadRowNames',true);
save('rna.mat', 'rna')

meth = readtable('methylation_sorted_out.csv','ReadRowNames',true);
save('meth.mat', 'meth')

[d,t1] = xlsread('clinical_sorted_out.xlsx');
response = categorical(d(:,2));
mirna.class = response;
feature_table =mirna;

rng(1)
% Use 70% of data for training and remaining for testing
split_training_testing = cvpartition(mirna.class, 'Holdout', 0.3);
% Dummyvar
mirna.class = dummyvar(mirna.class);
% Create a training set
training_set = feature_table(split_training_testing.training, :);

% Create a validation set
testing_set = feature_table(split_training_testing.test, :);

grpstats_training = grpstats(training_set, 'class', 'mean');
disp(grpstats_training(:,'GroupCount'))

% Create a random sub sample (to speed up training) from the training set
subsample = [1:height(training_set)];

% Create a 5-fold cross-validation set from training data
cvp = cvpartition(length(subsample),'KFold',5);

% Perform feature selection with neighborhood component feature selection
rng(1)
%test=training_set(:,477)
mdl = fscnca(table2array(training_set(:,1:(length(feature_table.Properties.VariableNames)-1))), ...
    table2array(training_set(:,length(feature_table.Properties.VariableNames))), 'Lambda', 0.005, 'Verbose', 0);

% Select features with weight above 1
selected_feature_indx = find(mdl.FeatureWeights > 0.1);


% Plot feature weights
figure
stem(mdl.FeatureWeights,'bo');
title('NCA: Selected features miRNA')
xlabel('Genes') 
ylabel('Feature Weight') 

% Load saved array of selected feature indexes to ensure reproducibility
%load('SelectedFeatures.mat')

% Display list of selected features
disp(feature_table.Properties.VariableNames(selected_feature_indx))
meth_sel_features =feature_table.Properties.VariableNames(selected_feature_indx)
%final_table = (table2array(feature_table(:,selected_feature_indx)))';
final_table = feature_table(:,selected_feature_indx);
writetable( final_table,'meth_sel_features_1genes.xlsx', 'WriteRowNames',true);
